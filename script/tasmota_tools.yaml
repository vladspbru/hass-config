##--------------------------------------------
## query states
##
sonoff_qry_state:
  sequence:
    - service: mqtt.publish
      data_template:
        topic: 'cmnd/{{id}}/STATE'
        payload: "?"
    - service: mqtt.publish
      data_template:
        topic: 'cmnd/{{id}}/POWER'
        payload: "?"
    #hak query tele
    - service: mqtt.publish
      data_template:
        topic: 'cmnd/{{id}}/TelePeriod'
        payload: "0"
    - service: mqtt.publish
      data_template:
        topic: 'cmnd/{{id}}/TelePeriod'
        payload: "300"
            
sonoff_qry_states:
  sequence:
    - service: script.sonoff_qry_state
      data:
        id: "sonoff_26575D"
    - service: script.sonoff_qry_state
      data:
        id: "sonoff_F4BC40"
#---------------------------------------------
    

##--------------------------------------------
## setup tasmota
##
sonoff_setup_cmd:
  sequence:
    - service: mqtt.publish
      data_template:
        #Return response as Command topic  
        topic: 'cmnd/{{id}}/SetOption4'
        payload: "1"
    - service: mqtt.publish
      data_template:
        #Set ButtonTopic to Topic and enable MQTT retain flag on button press 
        topic: 'cmnd/{{id}}/SwitchRetain'
        payload: "1"
    - service: mqtt.publish
      data_template:
        #Enable MQTT power retain on status update  
        topic: 'cmnd/{{id}}/PowerRetain'
        payload: "1"
    #queryFW
    - service: mqtt.publish
      data_template:
        topic: 'cmnd/{{id}}/status'
        payload: "0"

sonoff_setup_all:
  sequence:
    - service: script.sonoff_setup_cmd
      data:
        id: "sonoff_26575D"
    - service: script.sonoff_setup_cmd
      data:
        id: "sonoff_F4BC40"
##--------------------------------------------
            
##--------------------------------------------
## upgrade tasmota
##
sonoff_upgrade_cmd:
  sequence:
    #setup RESULT to cmnd
    - service: mqtt.publish
      data_template:
        topic: 'cmnd/{{id}}/SetOption4'
        payload: "1"
    #queryFW
    - service: mqtt.publish
      data_template:
        topic: 'cmnd/{{id}}/status'
        payload: "2"
    #upgrade
    - service: mqtt.publish
      data_template:
        topic: 'cmnd/{{id}}/otaurl'
        payload: "http://sonoff.maddox.co.uk/tasmota/sonoff.ino.bin"
    - service: mqtt.publish
      data_template:
        topic: 'cmnd/{{id}}/upgrade'
        payload: "1"
    #restart
    - service: mqtt.publish
      data_template:
        topic: 'cmnd/{{id}}/restart'
        payload: "1"
    
            
            
            
